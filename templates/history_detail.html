<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –∑–∞–ø—Ä–æ—Å–∞</title>
    <link rel="stylesheet" href="/static/success.css">
    <style>
        .screenshot-container {
            max-height: 600px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            overflow-y: auto; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
            border: 1px solid #ccc; /* –î–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Ä–∞–º–∫–∏ */
            width: 100%; /* –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
        }
        .screenshot-container img {
            width: 100%; /* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –ø–æ —à–∏—Ä–∏–Ω–µ */
            height: auto; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-wrapper">
            <h1>{{ record.vin_value or record.folder }} ({{ record.created }})</h1>
            <a href="/history" class="back-button">–ù–∞–∑–∞–¥ –∫ –∏—Å—Ç–æ—Ä–∏–∏</a>
            <div class="content-wrapper">
                <div class="left-column">
                    <div class="sidebar wide-sidebar">
                        <h2>–î–µ—Ç–∞–ª–∏ –∏ –ø–∏–∫—Ç–æ–≥—Ä–∞–º–º—ã</h2>
                        <div id="details-list" class="details-list"></div>
                    </div>
                    <div class="zones-container">
                        <h2>–ó–æ–Ω—ã</h2>
                        <div class="zone-row">
                            {% if record.main_svg_path %}
                            <a href="{{ record.main_svg_path }}" download class="svg-download" title="–°–∫–∞—á–∞—Ç—å SVG">
                                <span class="download-icon">‚¨á</span>
                            </a>
                            {% endif %}
                            <button class="all-zones-button" data-record="1">–í—Å–µ –∑–æ–Ω—ã</button>
                        </div>
                        <div id="zones-table" class="zones-table">
                            {% for zone in record.zone_data %}
                            <div class="zone-row">
                                <button class="zone-button" data-zone-title="{{ zone.title }}" data-record="1">{{ zone.title }}
                                    {% if zone.has_pictograms %}
                                    <span class="pictogram-icon">üñºÔ∏è</span>
                                    {% endif %}
                                </button>
                                {% if not zone.graphics_not_available and zone.svg_path %}
                                <a href="{{ zone.svg_path }}" download class="svg-download" title="–°–∫–∞—á–∞—Ç—å SVG">
                                    <span class="download-icon">‚¨á</span>
                                </a>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="right-column">
                    <div class="image-container">
                        <div class="screenshot-container">
                            <img id="main-screenshot" src="{{ record.main_screenshot_path }}" alt="–°–∫—Ä–∏–Ω—à–æ—Ç –∑–æ–Ω">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        async function checkFileExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch (e) {
                console.warn(`–§–∞–π–ª ${url} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${e}`);
                return false;
            }
        }

        const zoneData = {{ record.zone_data | tojson }};
        const zoneButtons = document.querySelectorAll('.zone-button');
        const detailsList = document.getElementById('details-list');
        const mainScreenshot = document.getElementById('main-screenshot');
        const allZonesButton = document.querySelector('.all-zones-button');

        console.log('Main screenshot path:', {{ record.main_screenshot_path | tojson }});
        console.log('Zone data:', zoneData);

        allZonesButton.addEventListener('click', async () => {
            zoneButtons.forEach(btn => btn.classList.remove('active'));
            detailsList.querySelectorAll('.detail-button').forEach(btn => btn.classList.remove('active'));
            const mainScreenshotPath = {{ record.main_screenshot_path | tojson }};
            mainScreenshot.src = (await checkFileExists(mainScreenshotPath)) ? mainScreenshotPath : '';
            detailsList.innerHTML = '';
        });

        zoneButtons.forEach(button => {
            button.addEventListener('click', async () => {
                zoneButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                const zoneTitle = button.getAttribute('data-zone-title');
                const zone = zoneData.find(z => z.title === zoneTitle);

                if (zone) {
                    const screenshotPath = zone.screenshot_path || {{ record.main_screenshot_path | tojson }};
                    mainScreenshot.src = (await checkFileExists(screenshotPath)) ? screenshotPath : '';
                    console.log('Zone screenshot path:', screenshotPath);

                    detailsList.innerHTML = '';

                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏
                    if (zone.details && zone.details.length > 0) {
                        for (const detail of zone.details) {
                            const detailRow = document.createElement('div');
                            detailRow.className = 'detail-row';
                            detailRow.innerHTML = `
                                <a href="${detail.svg_path}" download class="svg-download detail-svg-download" title="–°–∫–∞—á–∞—Ç—å SVG">
                                    <span class="download-icon">‚¨á</span>
                                </a>
                                <button class="detail-button" data-detail-title="${detail.title}">${detail.title}</button>
                            `;
                            const detailButton = detailRow.querySelector('.detail-button');
                            detailButton.addEventListener('click', async () => {
                                detailsList.querySelectorAll('.detail-button').forEach(btn => btn.classList.remove('active'));
                                detailButton.classList.add('active');
                                const detailSvgPath = detail.svg_path || zone.screenshot_path;
                                mainScreenshot.src = (await checkFileExists(detailSvgPath)) ? detailSvgPath : '';
                                console.log('Detail SVG path:', detailSvgPath);
                            });
                            detailsList.appendChild(detailRow);
                        }
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∏–∫—Ç–æ–≥—Ä–∞–º–º—ã
                    if (zone.pictograms && zone.pictograms.length > 0) {
                        for (const pictogram of zone.pictograms) {
                            for (const work of pictogram.works) {
                                const workTitle = work.work_name2 ? `${work.work_name1} (${work.work_name2})` : work.work_name1;
                                const detailRow = document.createElement('div');
                                detailRow.className = 'detail-row';
                                detailRow.innerHTML = `
                                    <a href="${work.svg_path}" download class="svg-download detail-svg-download" title="–°–∫–∞—á–∞—Ç—å SVG">
                                        <span class="download-icon">‚¨á</span>
                                    </a>
                                    <button class="detail-button" data-detail-title="${workTitle}">${workTitle}</button>
                                `;
                                const detailButton = detailRow.querySelector('.detail-button');
                                detailButton.addEventListener('click', async () => {
                                    detailsList.querySelectorAll('.detail-button').forEach(btn => btn.classList.remove('active'));
                                    detailButton.classList.add('active');
                                    const workSvgPath = work.svg_path || zone.screenshot_path;
                                    mainScreenshot.src = (await checkFileExists(workSvgPath)) ? workSvgPath : '';
                                    console.log('Work SVG path:', workSvgPath);
                                });
                                detailsList.appendChild(detailRow);
                            }
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>